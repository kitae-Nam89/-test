<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>프리랜서 TEST 관리자 페이지</title>
  <style>
    body {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "맑은 고딕", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .right {
      font-size: 13px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    header button {
      padding: 4px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    header .btn-open {
      background: #16a34a;
      color: #fff;
    }
    header .btn-close {
      background: #dc2626;
      color: #fff;
    }

    main {
      padding: 12px 18px 18px;
      display: grid;
      grid-template-columns: 2.3fr 1fr;
      gap: 12px;
    }
    h2 {
      font-size: 15px;
      margin: 0 0 6px 0;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .card-header .actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .card-header button {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
    .card-header button.primary {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }
    .card-header button.danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background: #f3f4f6;
    }
    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 3px 4px;
      vertical-align: middle;
      text-align: left;
    }
    th {
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    tbody tr.pending {
      background: #eff6ff;
    }
    tbody tr.pass {
      background: #ecfdf3;
    }
    tbody tr.fail {
      background: #fef2f2;
    }
    /* 반려 상태 행 배경색 */
    tbody tr.return {
      background: #fff7ed;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
    }
    .status-pill.pending {
      background: #e0f2fe;
      color: #0369a1;
    }
    .status-pill.pass {
      background: #dcfce7;
      color: #15803d;
    }
    .status-pill.fail {
      background: #fee2e2;
      color: #b91c1c;
    }
    /* 반려 pill 스타일 */
    .status-pill.return {
      background: #fed7aa;
      color: #c2410c;
    }

    .row-actions {
      display: flex;
      flex-wrap: wrap;      /* 가로로 배치 + 줄바꿈 */
      justify-content: flex-end;
      gap: 2px 4px;         /* 위아래 / 좌우 간격 */
    }
    .row-actions button {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      white-space: nowrap;
    }
    .row-actions button.sm-primary {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }
    .row-actions button.sm-danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      background: #e5e7eb;
      color: #374151;
    }

    .tag {
      display: inline-flex;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
    }

    .muted {
      color: #9ca3af;
    }

    #status-bar {
      font-size: 12px;
      color: #4b5563;
    }
    #status-bar span {
      margin-right: 8px;
    }

    .blacklist-form {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    .blacklist-form label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }
    .blacklist-form input,
    .blacklist-form textarea {
      font-size: 11px;
      padding: 3px 5px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      width: 100%;
    }
    .blacklist-form textarea {
      resize: vertical;
      min-height: 40px;
    }
    .blacklist-form button {
      align-self: flex-end;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    /* ----- 본문 보기 모달 ----- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-inner {
      width: min(900px, 96vw);
      max-height: 80vh;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .modal-header button {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
    .modal-body {
      padding: 10px 12px 12px;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow: auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>프리랜서 TEST 관리자</h1>
    <div class="right">
      <span id="test-open-indicator">TEST 상태: <strong>로딩 중...</strong></span>
      <button id="toggle-test-open-btn" class="btn-open">TEST 열기/닫기</button>
    </div>
  </header>

  <main>
    <!-- 지원자 목록 -->
    <section class="card">
      <div class="card-header">
        <h2>지원자 목록</h2>
        <div class="actions">
          <span id="status-bar" class="muted">총 0건</span>
          <button id="refresh-list-btn" class="primary">목록 새로고침</button>
          <button id="delete-all-btn" class="danger">전체 삭제</button>
        </div>
      </div>
      <div style="overflow:auto; max-height: 430px;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>지원자</th>
              <th>글자수<br />(공백 제외)</th>
              <th>상태</th>
              <th>생성/제출/마감</th>
              <th>관리</th>
            </tr>
          </thead>
          <tbody id="tests-tbody">
            <tr>
              <td colspan="6" class="muted">
                데이터를 불러오는 중이거나, 아직 제출된 TEST가 없습니다.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 블랙리스트 / TEST 설정 -->
    <section class="card">
      <div class="card-header">
        <h2>블랙리스트 & 설정</h2>
        <div class="actions">
          <button id="toggle-bl-body-btn">접기</button>
          <button id="refresh-bl-btn">새로고침</button>
        </div>
      </div>

      <div id="blacklist-body">
        <div class="blacklist-form">
          <strong style="font-size:12px;">블랙리스트 수동 등록</strong>
          <label>
            이름
            <input type="text" id="bl-name-input" placeholder="홍길동" />
          </label>
          <label>
            출생연도
            <input type="text" id="bl-birth-input" placeholder="1990" />
          </label>
          <label>
            휴대폰 뒷자리
            <input type="text" id="bl-last4-input" placeholder="1234" />
          </label>
          <label>
            사유
            <textarea id="bl-reason-input" placeholder="사유 메모 (선택)"></textarea>
          </label>
          <button id="bl-add-btn">블랙리스트 추가</button>
        </div>

        <div style="font-size:11px; margin-bottom:4px; color:#6b7280;">
          ※ 목록에서 개별 지원자 옆의 [블랙리스트] 버튼을 눌러 등록할 수도 있습니다.
        </div>

        <div style="overflow:auto; max-height: 260px;">
          <table>
            <thead>
              <tr>
                <th>이름/식별</th>
                <th>사유</th>
                <th>등록일</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="blacklist-tbody">
              <tr>
                <td colspan="4" class="muted">블랙리스트 데이터가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- 본문 보기 모달 -->
  <div id="viewer-modal" class="modal-overlay">
    <div class="modal-inner">
      <div class="modal-header">
        <div id="viewer-title">TEST 본문</div>
        <button type="button" id="viewer-close-btn">닫기</button>
      </div>
      <pre id="viewer-body" class="modal-body"></pre>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // -------- TEST 오픈 상태 --------
    async function loadConfig() {
      try {
        const res = await fetch("/api/writer-test/config");
        const data = await res.json();
        if (!res.ok) throw new Error("config load error");
        updateTestOpenUI(data.test_open);
      } catch (e) {
        console.error(e);
        $("#test-open-indicator").innerHTML =
          'TEST 상태: <strong style="color:#b91c1c;">불러오기 실패</strong>';
      }
    }

    function updateTestOpenUI(isOpen) {
      const ind = $("#test-open-indicator");
      const btn = $("#toggle-test-open-btn");
      if (isOpen) {
        ind.innerHTML = 'TEST 상태: <strong style="color:#22c55e;">열림</strong>';
        btn.textContent = "TEST 닫기";
        btn.classList.remove("btn-open");
        btn.classList.add("btn-close");
      } else {
        ind.innerHTML = 'TEST 상태: <strong style="color:#ef4444;">마감</strong>';
        btn.textContent = "TEST 열기";
        btn.classList.remove("btn-close");
        btn.classList.add("btn-open");
      }
      btn.dataset.open = isOpen ? "1" : "0";
    }

    async function toggleTestOpen() {
      const btn = $("#toggle-test-open-btn");
      const current = btn.dataset.open === "1";
      const next = !current;

      try {
        const res = await fetch("/api/writer-test/set_open_flag", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ test_open: next })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("toggle error");
        updateTestOpenUI(data.test_open);
      } catch (e) {
        console.error(e);
        alert("TEST 열림/마감 상태 변경 중 오류가 발생했습니다.");
      }
    }

    // -------- 개별 TEST 본문 보기 --------
    async function openViewer(id) {
      const modal = document.getElementById("viewer-modal");
      const titleEl = document.getElementById("viewer-title");
      const bodyEl = document.getElementById("viewer-body");

      if (!modal) {
        alert("보기 모달 요소를 찾을 수 없습니다.");
        return;
      }

      modal.style.display = "flex";
      titleEl.textContent = `ID #${id} - 본문 불러오는 중...`;
      bodyEl.textContent = "불러오는 중입니다...";

      try {
        const res = await fetch(`/api/writer-test/get?id=${encodeURIComponent(id)}`);
        const data = await res.json();
        if (!res.ok || !data.test) throw new Error("view error");

        const t = data.test;
        titleEl.textContent = `#${t.id} ${t.title || "(제목 없음)"}`;
        bodyEl.textContent = t.content || "(본문이 비어 있습니다.)";
      } catch (e) {
        console.error(e);
        bodyEl.textContent = "본문을 불러오는 중 오류가 발생했습니다.";
      }
    }

    // -------- TEST TXT 저장 --------
    async function downloadTestTxt(id, meta) {
      try {
        const res = await fetch(`/api/writer-test/get?id=${encodeURIComponent(id)}`);
        const data = await res.json();
        if (!res.ok || !data.test) throw new Error("download error");

        const t = data.test;
        const content = t.content || "";
        const title = (t.title || "").trim();

        if (!title && !content) {
          alert("저장할 내용이 없습니다.");
          return;
        }

        // 파일명: 이름_출생연도년생_뒷자리 형태 (앞에서 쓰던 그대로)
        const parts = [];
        if (meta.name) parts.push(meta.name);
        if (meta.birthYear) parts.push(meta.birthYear + "년생");
        if (meta.last4) parts.push(meta.last4);
        const baseName = (parts.join("_") || ("test_" + id)).replace(/[\\/:*?"<>|]/g, "_");

        // TXT 내용: "제목 → 빈 줄 → 본문"
        const text =
          (title ? title + "\n\n" : "") +
          content;

        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = baseName + ".txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e);
        alert("TXT 파일 저장 중 오류가 발생했습니다.");
      }
    }

    // -------- 지원자 목록 --------
    async function loadTests() {
      const tbody = $("#tests-tbody");
      tbody.innerHTML =
        '<tr><td colspan="6" class="muted">데이터를 불러오는 중입니다...</td></tr>';
      try {
        const res = await fetch("/api/writer-test/list");
        const data = await res.json();
        if (!res.ok) throw new Error("list load error");

        const tests = data.tests || [];

        const pendingCount = tests.filter((t) => t.status === "pending" || !t.status).length;
        const passCount = tests.filter((t) => t.status === "pass").length;
        const failCount = tests.filter((t) => t.status === "fail").length;
        const returnCount = tests.filter((t) => t.status === "return").length;

        $("#status-bar").innerHTML =
          "<span>총 " +
          tests.length +
          "건</span>" +
          "<span>| 대기 " +
          pendingCount +
          "건</span>" +
          "<span>| 합격 " +
          passCount +
          "건</span>" +
          "<span>| 불합격 " +
          failCount +
          "건</span>" +
          "<span>| 반려 " +
          returnCount +
          "건</span>";

        if (!tests.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="muted">아직 제출된 TEST가 없습니다.</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        tests.forEach((t, index) => {
          // 화면에 보이는 순번 (최신이 위에 오므로 length-index 형태)
          const displayIndex = tests.length - index;

          const tr = document.createElement("tr");
          tr.classList.add(t.status || "pending");

          let statusLabel = "검토 대기";
          let statusClass = "pending";
          if (t.status === "pass") {
            statusLabel = "합격";
            statusClass = "pass";
          } else if (t.status === "fail") {
            statusLabel = "불합격";
            statusClass = "fail";
          } else if (t.status === "return") {
            statusLabel = "반려";
            statusClass = "return";
          }

          tr.innerHTML = `
            <td>
              <div><strong>#${displayIndex}</strong></div>
              <div class="muted" style="font-size:10px;">${t.phoneLast4}</div>
            </td>
            <td>
              <div>
                <strong>${t.name}</strong>
                <span class="tag">${t.birthYear}년생</span>
              </div>
              <div class="muted" style="font-size:10px;">
                휴대폰 뒷자리 ${t.phoneLast4}
              </div>
              <div
                class="muted"
                style="font-size:10px; max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                title="${t.title || ""}"
              >
                ${t.title || "<span class='muted'>(제목 없음)</span>"}
              </div>
            </td>
            <td>
              <span class="badge">${(t.length || 0).toLocaleString()}자</span>
            </td>
            <td>
              <span class="status-pill ${statusClass}">${statusLabel}</span>
            </td>
            <td style="font-size:10px; line-height:1.3;">
              <div>생성: ${t.createdAt || "-"}</div>
              <div>제출: ${t.submittedAt || "-"}</div>
              <div>마감: ${t.deadlineAt || "-"}</div>
            </td>
            <td>
              <div class="row-actions">
                <button
                  type="button"
                  class="sm-primary"
                  data-action="view"
                  data-id="${t.id}"
                >
                  보기
                </button>
                <button type="button" data-status="pass" data-id="${t.id}">합격</button>
                <button type="button" data-status="fail" data-id="${t.id}">불합격</button>
                <button type="button" data-status="return" data-id="${t.id}">반려</button>
                <button type="button" data-status="pending" data-id="${t.id}">대기</button>
                <button type="button" data-action="blacklist" data-id="${t.id}">
                  블랙리스트
                </button>
                <button
                  type="button"
                  data-action="download-txt"
                  data-id="${t.id}"
                  data-name="${t.name}"
                  data-birth="${t.birthYear}"
                  data-last4="${t.phoneLast4}"
                >
                  TXT저장
                </button>
                <button
                  type="button"
                  class="sm-danger"
                  data-action="delete"
                  data-id="${t.id}"
                >
                  삭제
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

        const statusTextMap = {
          pass: "합격",
          fail: "불합격",
          pending: "대기",
          return: "반려"
        };

        // 내용 보기
        tbody.querySelectorAll("button[data-action='view']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            await openViewer(id);
          });
        });

        // 상태변경 버튼
        tbody.querySelectorAll("button[data-status]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const status = btn.getAttribute("data-status");
            if (!id) return;
            const label = statusTextMap[status] || status;
            if (!confirm("선택한 지원자의 상태를 '" + label + "'으로 변경하시겠습니까?")) {
              return;
            }
            await updateStatus(id, status);
          });
        });

        // 삭제
        tbody.querySelectorAll("button[data-action='delete']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            if (!confirm("선택한 지원자 정보를 삭제하시겠습니까?")) {
              return;
            }
            await deleteTest(id);
          });
        });

        // 블랙리스트 등록
        tbody.querySelectorAll("button[data-action='blacklist']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            const reason = prompt("블랙리스트 사유를 입력해 주세요 (선택):") || "";
            await addBlacklistById(id, reason);
          });
        });

        // TXT 저장
        tbody.querySelectorAll("button[data-action='download-txt']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            const name = btn.getAttribute("data-name") || "";
            const birthYear = btn.getAttribute("data-birth") || "";
            const last4 = btn.getAttribute("data-last4") || "";
            await downloadTestTxt(id, { name, birthYear, last4 });
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML =
          '<tr><td colspan="6" class="muted">목록을 불러오는 중 오류가 발생했습니다.</td></tr>';
      }
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch("/api/writer-test/update_status", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: Number(id), status })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("status update error");
        await loadTests();
      } catch (e) {
        console.error(e);
        alert("상태 변경 중 오류가 발생했습니다.");
      }
    }

    async function deleteTest(id) {
      try {
        const res = await fetch("/api/writer-test/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: Number(id) })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("delete error");
        await loadTests();
      } catch (e) {
        console.error(e);
        alert("삭제 중 오류가 발생했습니다.");
      }
    }

    async function deleteAllTests() {
      if (!confirm("정말 모든 TEST 데이터를 삭제하시겠습니까?")) return;
      try {
        const res = await fetch("/api/writer-test/delete_all", {
          method: "POST"
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("delete all error");
        await loadTests();
      } catch (e) {
        console.error(e);
        alert("전체 삭제 중 오류가 발생했습니다.");
      }
    }

    // -------- 블랙리스트 --------
    async function loadBlacklist() {
      const tbody = $("#blacklist-tbody");
      tbody.innerHTML =
        '<tr><td colspan="4" class="muted">데이터를 불러오는 중입니다...</td></tr>';
      try {
        const res = await fetch("/api/writer-test/blacklist");
        const data = await res.json();
        if (!res.ok) throw new Error("blacklist load error");

        const list = data.blacklist || [];
        if (!list.length) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="muted">블랙리스트 데이터가 없습니다.</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        list.forEach((b) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div><strong>${b.name}</strong></div>
              <div class="muted" style="font-size:10px;">${b.birthYear}년생 / ${b.phoneLast4}</div>
            </td>
            <td style="font-size:11px;">
              ${b.reason || "<span class='muted'>(사유 없음)</span>"}
            </td>
            <td style="font-size:11px;">
              ${b.createdAt || "-"}
            </td>
            <td>
              <button data-name="${b.name}" data-birth="${b.birthYear}" data-last4="${b.phoneLast4}">해제</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const name = btn.getAttribute("data-name");
            const birthYear = btn.getAttribute("data-birth");
            const last4 = btn.getAttribute("data-last4");
            if (
              !confirm(
                `블랙리스트에서 제거하시겠습니까?\n\n이름: ${name}\n출생연도: ${birthYear}\n뒷자리: ${last4}`
              )
            ) {
              return;
            }
            await removeBlacklist(name, birthYear, last4);
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML =
          '<tr><td colspan="4" class="muted">블랙리스트를 불러오는 중 오류가 발생했습니다.</td></tr>';
      }
    }

    async function addBlacklistById(id, reason) {
      try {
        const res = await fetch("/api/writer-test/blacklist_add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: Number(id), reason })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("bl add error");
        alert("블랙리스트에 추가되었습니다.");
        await loadBlacklist();
      } catch (e) {
        console.error(e);
        alert("블랙리스트 등록 중 오류가 발생했습니다.");
      }
    }

    async function addBlacklistManual() {
      const name = $("#bl-name-input").value.trim();
      const birthYear = $("#bl-birth-input").value.trim();
      const last4 = $("#bl-last4-input").value.trim();
      const reason = $("#bl-reason-input").value.trim();

      if (!name || !birthYear || !last4 || last4.length !== 4) {
        alert("이름, 출생연도, 휴대폰 뒷자리 4자리를 정확히 입력해 주세요.");
        return;
      }

      try {
        const res = await fetch("/api/writer-test/blacklist_add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            birthYear,
            phoneLast4: last4,
            reason
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("manual bl add error");
        alert("블랙리스트에 추가되었습니다.");
        $("#bl-name-input").value = "";
        $("#bl-birth-input").value = "";
        $("#bl-last4-input").value = "";
        $("#bl-reason-input").value = "";
        await loadBlacklist();
      } catch (e) {
        console.error(e);
        alert("블랙리스트 등록 중 오류가 발생했습니다.");
      }
    }

    async function removeBlacklist(name, birthYear, last4) {
      try {
        const res = await fetch("/api/writer-test/blacklist_remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            birthYear,
            phoneLast4: last4
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("bl remove error");
        await loadBlacklist();
      } catch (e) {
        console.error(e);
        alert("블랙리스트 해제 중 오류가 발생했습니다.");
      }
    }

    // -------- 블랙리스트 접기/열기 --------
    function toggleBlacklistBody() {
      const body = document.getElementById("blacklist-body");
      const btn = document.getElementById("toggle-bl-body-btn");
      if (!body || !btn) return;
      const hidden = body.style.display === "none";
      body.style.display = hidden ? "block" : "none";
      btn.textContent = hidden ? "접기" : "열기";
    }

    // -------- 초기화 --------
    window.addEventListener("DOMContentLoaded", () => {
      loadConfig();
      loadTests();
      loadBlacklist();

      $("#toggle-test-open-btn").addEventListener("click", toggleTestOpen);
      $("#refresh-list-btn").addEventListener("click", loadTests);
      $("#delete-all-btn").addEventListener("click", deleteAllTests);
      $("#refresh-bl-btn").addEventListener("click", loadBlacklist);
      $("#bl-add-btn").addEventListener("click", addBlacklistManual);
      $("#toggle-bl-body-btn").addEventListener("click", toggleBlacklistBody);

      const viewerCloseBtn = document.getElementById("viewer-close-btn");
      if (viewerCloseBtn) {
        viewerCloseBtn.addEventListener("click", () => {
          document.getElementById("viewer-modal").style.display = "none";
        });
      }
    });
  </script>
</body>
</html>
