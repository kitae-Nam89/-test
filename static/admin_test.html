<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í”„ë¦¬ëœì„œ TEST ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body {
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "ë§‘ì€ ê³ ë”•", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .right {
      font-size: 13px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    header button {
      padding: 4px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    header .btn-open {
      background: #16a34a;
      color: #fff;
    }
    header .btn-close {
      background: #dc2626;
      color: #fff;
    }

    main {
      padding: 12px 18px 18px;
      display: grid;
      grid-template-columns: 2.3fr 1fr;
      gap: 12px;
    }
    h2 {
      font-size: 15px;
      margin: 0 0 6px 0;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .card-header .actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .card-header button {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
    .card-header button.primary {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }
    .card-header button.danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background: #f3f4f6;
    }
    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 3px 4px;
      vertical-align: middle;
      text-align: left;
    }
    th {
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    tbody tr.pending {
      background: #eff6ff;
    }
    tbody tr.pass {
      background: #ecfdf3;
    }
    tbody tr.fail {
      background: #fef2f2;
    }
    /* ë°˜ë ¤ ìƒíƒœ í–‰ ë°°ê²½ìƒ‰ */
    tbody tr.return {
      background: #fff7ed;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
    }
    .status-pill.pending {
      background: #e0f2fe;
      color: #0369a1;
    }
    .status-pill.pass {
      background: #dcfce7;
      color: #15803d;
    }
    .status-pill.fail {
      background: #fee2e2;
      color: #b91c1c;
    }
    /* ë°˜ë ¤ pill ìŠ¤íƒ€ì¼ */
    .status-pill.return {
      background: #fed7aa;
      color: #c2410c;
    }

    .row-actions {
      display: flex;
      flex-wrap: wrap;      /* ê°€ë¡œë¡œ ë°°ì¹˜ + ì¤„ë°”ê¿ˆ */
      justify-content: flex-end;
      gap: 2px 4px;         /* ìœ„ì•„ë˜ / ì¢Œìš° ê°„ê²© */
    }
    .row-actions button {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      white-space: nowrap;
    }
    .row-actions button.sm-primary {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }
    .row-actions button.sm-danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      background: #e5e7eb;
      color: #374151;
    }

    .tag {
      display: inline-flex;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
    }

    .muted {
      color: #9ca3af;
    }

    #status-bar {
      font-size: 12px;
      color: #4b5563;
    }
    #status-bar span {
      margin-right: 8px;
    }

    .blacklist-form {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    .blacklist-form label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }
    .blacklist-form input,
    .blacklist-form textarea {
      font-size: 11px;
      padding: 3px 5px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      width: 100%;
    }
    .blacklist-form textarea {
      resize: vertical;
      min-height: 40px;
    }
    .blacklist-form button {
      align-self: flex-end;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    /* ----- ë³¸ë¬¸ ë³´ê¸° ëª¨ë‹¬ ----- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-inner {
      width: min(900px, 96vw);
      max-height: 80vh;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .modal-header button {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }
    .modal-body {
      padding: 10px 12px 12px;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow: auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>í”„ë¦¬ëœì„œ TEST ê´€ë¦¬ì</h1>
    <div class="right">
      <span id="test-open-indicator">TEST ìƒíƒœ: <strong>ë¡œë”© ì¤‘...</strong></span>
      <button id="toggle-test-open-btn" class="btn-open">TEST ì—´ê¸°/ë‹«ê¸°</button>
    </div>
  </header>

  <main>
    <!-- ì§€ì›ì ëª©ë¡ -->
    <section class="card">
      <div class="card-header">
        <h2>ì§€ì›ì ëª©ë¡</h2>
        <div class="actions">
          <span id="status-bar" class="muted">ì´ 0ê±´</span>
          <button id="refresh-list-btn" class="primary">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
          <button id="delete-all-btn" class="danger">ì „ì²´ ì‚­ì œ</button>
        </div>
      </div>
      <div style="overflow:auto; max-height: 430px;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ì§€ì›ì</th>
              <th>ê¸€ììˆ˜<br />(ê³µë°± ì œì™¸)</th>
              <th>ìƒíƒœ</th>
              <th>ìƒì„±/ì œì¶œ/ë§ˆê°</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="tests-tbody">
            <tr>
              <td colspan="6" class="muted">
                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ê±°ë‚˜, ì•„ì§ ì œì¶œëœ TESTê°€ ì—†ìŠµë‹ˆë‹¤.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ë¸”ë™ë¦¬ìŠ¤íŠ¸ / TEST ì„¤ì • -->
    <section class="card">
      <div class="card-header">
        <h2>ë¸”ë™ë¦¬ìŠ¤íŠ¸ & ì„¤ì •</h2>
        <div class="actions">
          <button id="toggle-bl-body-btn">ì ‘ê¸°</button>
          <button id="refresh-bl-btn">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <div id="blacklist-body">
        <div class="blacklist-form">
          <strong style="font-size:12px;">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìˆ˜ë™ ë“±ë¡</strong>
          <label>
            ì´ë¦„
            <input type="text" id="bl-name-input" placeholder="í™ê¸¸ë™" />
          </label>
          <label>
            ì¶œìƒì—°ë„
            <input type="text" id="bl-birth-input" placeholder="1990" />
          </label>
          <label>
            íœ´ëŒ€í° ë’·ìë¦¬
            <input type="text" id="bl-last4-input" placeholder="1234" />
          </label>
          <label>
            ì‚¬ìœ 
            <textarea id="bl-reason-input" placeholder="ì‚¬ìœ  ë©”ëª¨ (ì„ íƒ)"></textarea>
          </label>
          <button id="bl-add-btn">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button>
        </div>

        <div style="font-size:11px; margin-bottom:4px; color:#6b7280;">
          â€» ëª©ë¡ì—ì„œ ê°œë³„ ì§€ì›ì ì˜†ì˜ [ë¸”ë™ë¦¬ìŠ¤íŠ¸] ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“±ë¡í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        </div>

        <div style="overflow:auto; max-height: 260px;">
          <table>
            <thead>
              <tr>
                <th>ì´ë¦„/ì‹ë³„</th>
                <th>ì‚¬ìœ </th>
                <th>ë“±ë¡ì¼</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="blacklist-tbody">
              <tr>
                <td colspan="4" class="muted">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ë³¸ë¬¸ ë³´ê¸° ëª¨ë‹¬ -->
  <div id="viewer-modal" class="modal-overlay">
    <div class="modal-inner">
      <div class="modal-header">
        <div id="viewer-title">TEST ë³¸ë¬¸</div>
        <button type="button" id="viewer-close-btn">ë‹«ê¸°</button>
      </div>
      <pre id="viewer-body" class="modal-body"></pre>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // -------- TEST ì˜¤í”ˆ ìƒíƒœ --------
    async function loadConfig() {
      try {
        const res = await fetch("/api/writer-test/config");
        const data = await res.json();
        if (!res.ok) throw new Error("config load error");
        updateTestOpenUI(data.test_open);
      } catch (e) {
        console.error(e);
        $("#test-open-indicator").innerHTML =
          'TEST ìƒíƒœ: <strong style="color:#b91c1c;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</strong>';
      }
    }

    function updateTestOpenUI(isOpen) {
      const ind = $("#test-open-indicator");
      const btn = $("#toggle-test-open-btn");
      if (isOpen) {
        ind.innerHTML = 'TEST ìƒíƒœ: <strong style="color:#22c55e;">ì—´ë¦¼</strong>';
        btn.textContent = "TEST ë‹«ê¸°";
        btn.classList.remove("btn-open");
        btn.classList.add("btn-close");
      } else {
        ind.innerHTML = 'TEST ìƒíƒœ: <strong style="color:#ef4444;">ë§ˆê°</strong>';
        btn.textContent = "TEST ì—´ê¸°";
        btn.classList.remove("btn-close");
        btn.classList.add("btn-open");
      }
      btn.dataset.open = isOpen ? "1" : "0";
    }

async function toggleTestOpen() {
  const btn = $("#toggle-test-open-btn");
  const current = btn.dataset.open === "1"; // í˜„ì¬ ìƒíƒœ (true = ì—´ë¦¼)
  const next = !current;                    // ë³€ê²½ í›„ ìƒíƒœ

  // ğŸ‘‰ ì—´ë¦¼ â†’ ë§ˆê° ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²½ìš°: ë°±ì—… + ì´ˆê¸°í™” ì•ˆë‚´
  if (current && !next) {
    const ok = confirm(
      "TESTë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n" +
      "â€¢ ì§€ì›ì ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ PCì— ë°±ì—…í•˜ê³ ,\n" +
      "â€¢ ì„œë²„(DB)ì— ì €ì¥ëœ TEST ë‹µì•ˆì€ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤."
    );
    if (!ok) return;
  }

  try {
    // 1) ì—´ë¦¼/ë§ˆê° í”Œë˜ê·¸ ë¨¼ì € ë³€ê²½
    const res = await fetch("/api/writer-test/set_open_flag", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ test_open: next })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error("toggle error");

    // UI ê°±ì‹ 
    updateTestOpenUI(data.test_open);

    // 2) ë°©ê¸ˆ "ì—´ë¦¼ â†’ ë§ˆê°" ìœ¼ë¡œ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ
    //    ë°±ì—… + ì´ˆê¸°í™” API í˜¸ì¶œ (CSV ë‹¤ìš´ë¡œë“œ)
    if (current && !next) {
      alert(
        "TESTê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
        "ì´ì œ ì§€ì›ì ë°ì´í„° ë°±ì—… íŒŒì¼(CSV)ì´ ë‹¤ìš´ë¡œë“œë˜ê³ ,\n" +
        "ì„œë²„ì— ì €ì¥ëœ TEST ë‹µì•ˆì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤."
      );
      // GET /api/writer-test/export_and_reset
      // â†’ CSV ë‹¤ìš´ë¡œë“œ + writer_tests ë‚´ìš© ì´ˆê¸°í™”
      window.location.href = "/api/writer-test/export_and_reset";
    }
  } catch (e) {
    console.error(e);
    alert("TEST ì—´ë¦¼/ë§ˆê° ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

    // -------- ê°œë³„ TEST ë³¸ë¬¸ ë³´ê¸° --------
    async function openViewer(id) {
      const modal = document.getElementById("viewer-modal");
      const titleEl = document.getElementById("viewer-title");
      const bodyEl = document.getElementById("viewer-body");

      if (!modal) {
        alert("ë³´ê¸° ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      modal.style.display = "flex";
      titleEl.textContent = `ID #${id} - ë³¸ë¬¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;
      bodyEl.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const res = await fetch(`/api/writer-test/get?id=${encodeURIComponent(id)}`);
        const data = await res.json();
        if (!res.ok || !data.test) throw new Error("view error");

        const t = data.test;
        titleEl.textContent = `#${t.id} ${t.title || "(ì œëª© ì—†ìŒ)"}`;
        bodyEl.textContent = t.content || "(ë³¸ë¬¸ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.)";
      } catch (e) {
        console.error(e);
        bodyEl.textContent = "ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // -------- TEST TXT ì €ì¥ --------
    async function downloadTestTxt(id, meta) {
      try {
        const res = await fetch(`/api/writer-test/get?id=${encodeURIComponent(id)}`);
        const data = await res.json();
        if (!res.ok || !data.test) throw new Error("download error");

        const t = data.test;
        const content = t.content || "";
        const title = (t.title || "").trim();

        if (!title && !content) {
          alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // íŒŒì¼ëª…: ì´ë¦„_ì¶œìƒì—°ë„ë…„ìƒ_ë’·ìë¦¬ í˜•íƒœ (ì•ì—ì„œ ì“°ë˜ ê·¸ëŒ€ë¡œ)
        const parts = [];
        if (meta.name) parts.push(meta.name);
        if (meta.birthYear) parts.push(meta.birthYear + "ë…„ìƒ");
        if (meta.last4) parts.push(meta.last4);
        const baseName = (parts.join("_") || ("test_" + id)).replace(/[\\/:*?"<>|]/g, "_");

        // TXT ë‚´ìš©: "ì œëª© â†’ ë¹ˆ ì¤„ â†’ ë³¸ë¬¸"
        const text =
          (title ? title + "\n\n" : "") +
          content;

        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = baseName + ".txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e);
        alert("TXT íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // -------- ì§€ì›ì ëª©ë¡ --------
    async function loadTests() {
      const tbody = $("#tests-tbody");
      tbody.innerHTML =
        '<tr><td colspan="6" class="muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>';
      try {
        const res = await fetch("/api/writer-test/list");
        const data = await res.json();
        if (!res.ok) throw new Error("list load error");

        const tests = data.tests || [];

        const pendingCount = tests.filter((t) => t.status === "pending" || !t.status).length;
        const passCount = tests.filter((t) => t.status === "pass").length;
        const failCount = tests.filter((t) => t.status === "fail").length;
        const returnCount = tests.filter((t) => t.status === "return").length;

        $("#status-bar").innerHTML =
          "<span>ì´ " +
          tests.length +
          "ê±´</span>" +
          "<span>| ëŒ€ê¸° " +
          pendingCount +
          "ê±´</span>" +
          "<span>| í•©ê²© " +
          passCount +
          "ê±´</span>" +
          "<span>| ë¶ˆí•©ê²© " +
          failCount +
          "ê±´</span>" +
          "<span>| ë°˜ë ¤ " +
          returnCount +
          "ê±´</span>";

        if (!tests.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="muted">ì•„ì§ ì œì¶œëœ TESTê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        tests.forEach((t, index) => {
          // í™”ë©´ì— ë³´ì´ëŠ” ìˆœë²ˆ (ìµœì‹ ì´ ìœ„ì— ì˜¤ë¯€ë¡œ length-index í˜•íƒœ)
          const displayIndex = tests.length - index;

          const tr = document.createElement("tr");
          tr.classList.add(t.status || "pending");

          let statusLabel = "ê²€í†  ëŒ€ê¸°";
          let statusClass = "pending";
          if (t.status === "pass") {
            statusLabel = "í•©ê²©";
            statusClass = "pass";
          } else if (t.status === "fail") {
            statusLabel = "ë¶ˆí•©ê²©";
            statusClass = "fail";
          } else if (t.status === "return") {
            statusLabel = "ë°˜ë ¤";
            statusClass = "return";
          }

          tr.innerHTML = `
            <td>
              <div><strong>#${displayIndex}</strong></div>
              <div class="muted" style="font-size:10px;">${t.phoneLast4}</div>
            </td>
            <td>
              <div>
                <strong>${t.name}</strong>
                <span class="tag">${t.birthYear}ë…„ìƒ</span>
              </div>
              <div class="muted" style="font-size:10px;">
                íœ´ëŒ€í° ë’·ìë¦¬ ${t.phoneLast4}
              </div>
              <div
                class="muted"
                style="font-size:10px; max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                title="${t.title || ""}"
              >
                ${t.title || "<span class='muted'>(ì œëª© ì—†ìŒ)</span>"}
              </div>
            </td>
            <td>
              <span class="badge">${(t.length || 0).toLocaleString()}ì</span>
            </td>
            <td>
              <span class="status-pill ${statusClass}">${statusLabel}</span>
            </td>
            <td style="font-size:10px; line-height:1.3;">
              <div>ìƒì„±: ${t.createdAt || "-"}</div>
              <div>ì œì¶œ: ${t.submittedAt || "-"}</div>
              <div>ë§ˆê°: ${t.deadlineAt || "-"}</div>
            </td>
            <td>
              <div class="row-actions">
                <button
                  type="button"
                  class="sm-primary"
                  data-action="view"
                  data-id="${t.id}"
                >
                  ë³´ê¸°
                </button>
                <button type="button" data-status="pass" data-id="${t.id}">í•©ê²©</button>
                <button type="button" data-status="fail" data-id="${t.id}">ë¶ˆí•©ê²©</button>
                <button type="button" data-status="return" data-id="${t.id}">ë°˜ë ¤</button>
                <button type="button" data-status="pending" data-id="${t.id}">ëŒ€ê¸°</button>
                <button type="button" data-action="blacklist" data-id="${t.id}">
                  ë¸”ë™ë¦¬ìŠ¤íŠ¸
                </button>
                <button
                  type="button"
                  data-action="download-txt"
                  data-id="${t.id}"
                  data-name="${t.name}"
                  data-birth="${t.birthYear}"
                  data-last4="${t.phoneLast4}"
                >
                  TXTì €ì¥
                </button>
                <button
                  type="button"
                  class="sm-danger"
                  data-action="delete"
                  data-id="${t.id}"
                >
                  ì‚­ì œ
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

        const statusTextMap = {
          pass: "í•©ê²©",
          fail: "ë¶ˆí•©ê²©",
          pending: "ëŒ€ê¸°",
          return: "ë°˜ë ¤"
        };

        // ë‚´ìš© ë³´ê¸°
        tbody.querySelectorAll("button[data-action='view']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            await openViewer(id);
          });
        });

        // ìƒíƒœë³€ê²½ ë²„íŠ¼
        tbody.querySelectorAll("button[data-status]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const status = btn.getAttribute("data-status");
            if (!id) return;
            const label = statusTextMap[status] || status;
            if (!confirm("ì„ íƒí•œ ì§€ì›ìì˜ ìƒíƒœë¥¼ '" + label + "'ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              return;
            }
            await updateStatus(id, status);
          });
        });

        // ì‚­ì œ
        tbody.querySelectorAll("button[data-action='delete']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            if (!confirm("ì„ íƒí•œ ì§€ì›ì ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              return;
            }
            await deleteTest(id);
          });
        });

        // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡
        tbody.querySelectorAll("button[data-action='blacklist']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            const reason = prompt("ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì„ íƒ):") || "";
            await addBlacklistById(id, reason);
          });
        });

        // TXT ì €ì¥
        tbody.querySelectorAll("button[data-action='download-txt']").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            const name = btn.getAttribute("data-name") || "";
            const birthYear = btn.getAttribute("data-birth") || "";
            const last4 = btn.getAttribute("data-last4") || "";
            await downloadTestTxt(id, { name, birthYear, last4 });
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML =
          '<tr><td colspan="6" class="muted">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch("/api/writer-test/update_status", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: Number(id), status })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("status update error");
        await loadTests();
      } catch (e) {
        console.error(e);
        alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function deleteTest(id) {
      try {
        const res = await fetch("/api/writer-test/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: Number(id) })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("delete error");
        await loadTests();
      } catch (e) {
        console.error(e);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

async function deleteAllTests() {
  // ğŸ”’ TESTê°€ ì—´ë ¤ ìˆëŠ” ë™ì•ˆì—ëŠ” ì „ì²´ ì‚­ì œ ê¸ˆì§€
  const btnToggle = $("#toggle-test-open-btn");
  const isOpen = btnToggle.dataset.open === "1";
  if (isOpen) {
    alert("TEST ì§„í–‰ ì¤‘ì—ëŠ” ì „ì²´ ì‚­ì œë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n" +
          "ë¨¼ì € TESTë¥¼ ë§ˆê°í•œ ë’¤(ìƒë‹¨ ë²„íŠ¼),\n" +
          "í•„ìš”í•˜ë‹¤ë©´ ë‹¤ì‹œ ì „ì²´ ì‚­ì œë¥¼ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.");
    return;
  }

  if (!confirm("ì •ë§ ëª¨ë“  TEST ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    const res = await fetch("/api/writer-test/delete_all", {
      method: "POST"
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error("delete all error");
    await loadTests();
  } catch (e) {
    console.error(e);
    alert("ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


    // -------- ë¸”ë™ë¦¬ìŠ¤íŠ¸ --------
    async function loadBlacklist() {
      const tbody = $("#blacklist-tbody");
      tbody.innerHTML =
        '<tr><td colspan="4" class="muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>';
      try {
        const res = await fetch("/api/writer-test/blacklist");
        const data = await res.json();
        if (!res.ok) throw new Error("blacklist load error");

        const list = data.blacklist || [];
        if (!list.length) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="muted">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        list.forEach((b) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div><strong>${b.name}</strong></div>
              <div class="muted" style="font-size:10px;">${b.birthYear}ë…„ìƒ / ${b.phoneLast4}</div>
            </td>
            <td style="font-size:11px;">
              ${b.reason || "<span class='muted'>(ì‚¬ìœ  ì—†ìŒ)</span>"}
            </td>
            <td style="font-size:11px;">
              ${b.createdAt || "-"}
            </td>
            <td>
              <button data-name="${b.name}" data-birth="${b.birthYear}" data-last4="${b.phoneLast4}">í•´ì œ</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const name = btn.getAttribute("data-name");
            const birthYear = btn.getAttribute("data-birth");
            const last4 = btn.getAttribute("data-last4");
            if (
              !confirm(
                `ë¸”ë™ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ë¦„: ${name}\nì¶œìƒì—°ë„: ${birthYear}\në’·ìë¦¬: ${last4}`
              )
            ) {
              return;
            }
            await removeBlacklist(name, birthYear, last4);
          });
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML =
          '<tr><td colspan="4" class="muted">ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    async function addBlacklistById(id, reason) {
      try {
        const res = await fetch("/api/writer-test/blacklist_add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: Number(id), reason })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("bl add error");
        alert("ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadBlacklist();
      } catch (e) {
        console.error(e);
        alert("ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function addBlacklistManual() {
      const name = $("#bl-name-input").value.trim();
      const birthYear = $("#bl-birth-input").value.trim();
      const last4 = $("#bl-last4-input").value.trim();
      const reason = $("#bl-reason-input").value.trim();

      if (!name || !birthYear || !last4 || last4.length !== 4) {
        alert("ì´ë¦„, ì¶œìƒì—°ë„, íœ´ëŒ€í° ë’·ìë¦¬ 4ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch("/api/writer-test/blacklist_add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            birthYear,
            phoneLast4: last4,
            reason
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("manual bl add error");
        alert("ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        $("#bl-name-input").value = "";
        $("#bl-birth-input").value = "";
        $("#bl-last4-input").value = "";
        $("#bl-reason-input").value = "";
        await loadBlacklist();
      } catch (e) {
        console.error(e);
        alert("ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function removeBlacklist(name, birthYear, last4) {
      try {
        const res = await fetch("/api/writer-test/blacklist_remove", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            birthYear,
            phoneLast4: last4
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error("bl remove error");
        await loadBlacklist();
      } catch (e) {
        console.error(e);
        alert("ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // -------- ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì ‘ê¸°/ì—´ê¸° --------
    function toggleBlacklistBody() {
      const body = document.getElementById("blacklist-body");
      const btn = document.getElementById("toggle-bl-body-btn");
      if (!body || !btn) return;
      const hidden = body.style.display === "none";
      body.style.display = hidden ? "block" : "none";
      btn.textContent = hidden ? "ì ‘ê¸°" : "ì—´ê¸°";
    }

    // -------- ì´ˆê¸°í™” --------
    window.addEventListener("DOMContentLoaded", () => {
      loadConfig();
      loadTests();
      loadBlacklist();

      $("#toggle-test-open-btn").addEventListener("click", toggleTestOpen);
      $("#refresh-list-btn").addEventListener("click", loadTests);
      $("#delete-all-btn").addEventListener("click", deleteAllTests);
      $("#refresh-bl-btn").addEventListener("click", loadBlacklist);
      $("#bl-add-btn").addEventListener("click", addBlacklistManual);
      $("#toggle-bl-body-btn").addEventListener("click", toggleBlacklistBody);

      const viewerCloseBtn = document.getElementById("viewer-close-btn");
      if (viewerCloseBtn) {
        viewerCloseBtn.addEventListener("click", () => {
          document.getElementById("viewer-modal").style.display = "none";
        });
      }
    });
  </script>
</body>
</html>
